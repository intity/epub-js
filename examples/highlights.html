<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB.js Highlights Example</title>
    <link rel="stylesheet" type="text/css" href="examples.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="../dist/epub.js"></script>
</head>

<body>
    <div id="content">
        <div id="viewer" class="spreads">
            <div id="divider"></div>
        </div>
        <a id="prev" href="#prev" class="arrow"></a>
        <a id="next" href="#next" class="arrow"></a>
    </div>
    <div id="extras">
        <ul id="highlights"></ul>
    </div>
    <script>
        const highlights = document.getElementById("highlights")
        const prev = document.getElementById("prev")
        const next = document.getElementById("next")
        const book = ePub("https://s3.amazonaws.com/epubjs/books/alice.epub")
        const rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
            ignoreClass: "annotator-hl",
            //manager: "continuous"
        })
        const displayed = rendition.display(6)
        prev.onclick = (e) => {
            rendition.prev()
            e.preventDefault()
        }
        next.onclick = (e) => {
            rendition.next()
            e.preventDefault()
        }
        const keybinding = (e) => {
            const dir = rendition.layout.direction
            switch (e.key) {
                case "ArrowLeft":
                    dir === "ltr" ? rendition.prev() : rendition.next()
                    break
                case "ArrowRight":
                    dir === "ltr" ? rendition.next() : rendition.prev()
                    break
            }
        }
        document.onkeyup = keybinding
        rendition.on("keyup", keybinding)
        rendition.on("selected", (cfiRange, contents) => {

            rendition.annotations.highlight(cfiRange, {}, (e) => {
                console.log(e.target)
            })
            book.getRange(cfiRange).then((range) => {

                const list = document.createElement("li")
                const link = document.createElement("a")
                const ctrl = document.createElement("a")

                if (range) {
                    const text = range.toString()
                    const node = document.createTextNode(text)

                    link.textContent = cfiRange
                    link.href = "#" + cfiRange
                    link.onclick = (e) => {

                        rendition.display(cfiRange)
                        e.preventDefault()
                    }

                    ctrl.textContent = "remove"
                    ctrl.href = "#"
                    ctrl.onclick = (e) => {

                        rendition.annotations.remove(cfiRange, "highlight")
                        highlights.removeChild(list)
                        e.preventDefault()
                    }

                    list.appendChild(link)
                    list.appendChild(node)
                    list.appendChild(ctrl)
                    highlights.appendChild(list)
                }
            })
            contents.window.getSelection().removeAllRanges()
        })
        rendition.on("relocated", (location) => {
            //console.log(location)
        })
    </script>
</body>

</html>