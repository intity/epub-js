<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>EPUB.js Spreads Example</title>
	<link rel="stylesheet" type="text/css" href="examples.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="../dist/epub.js"></script>
</head>

<body>
	<div id="title"></div>
	<div id="content">
		<div id="viewer" class="spreads">
			<div id="divider"></div>
		</div>
	</div>
	<a id="prev" href="#prev" class="arrow">‹</a>
	<a id="next" href="#next" class="arrow">›</a>
	<div id="controls">
		<input type="text" value="0" disabled="disabled" size="3" id="current-percent" /> %
		<input type="range" min="0" max="100" value="0" id="slider" />
	</div>
	<script>
		const title = document.getElementById("title")
		const controls = document.getElementById("controls")
		const currentPage = document.getElementById("current-percent")
		const slider = document.getElementById("slider")
		const book = ePub("https://s3.amazonaws.com/epubjs/books/alice.epub")
		const rendition = book.renderTo("viewer", {
			width: "100%",
			height: "100%"
		})
		const displayed = rendition.display()
		const prev = document.getElementById("prev")
		prev.onclick = (e) => {

			rendition.prev()
			e.preventDefault()
		}
		const next = document.getElementById("next")
		next.onclick = (e) => {

			rendition.next()
			e.preventDefault()
		}
		const locationFrom = (value) => {

			const val = parseInt(value) / 100
			const cfi = book.locations.cfiFromPercentage(val)
			const loc = book.locations.locationFromCfi(cfi)
			return { cfi, loc }
		}
		let atStart = false, atEnd = false
		const update = (location) => {

			if (location.atStart) {
				prev.style.display = "none"
				atStart = true
			} else {
				prev.style.display = "block"
				atStart = false
			}
			if (location.atEnd) {
				next.style.display = "none"
				atEnd = true
			} else {
				next.style.display = "block"
				atEnd = false
			}

			const percentage = book.locations.percentageFromCfi(location.start.cfi)
			const percent = Math.floor(percentage * 100)
			slider.value = percent
			currentPage.value = percent
			book.locations.currentLocation = locationFrom(percent).loc
		}
		const keybinding = (e) => {

			if (e.key === "ArrowLeft" && !atStart) {
				rendition.prev()
			}

			if (e.key === "ArrowRight" && !atEnd) {
				rendition.next()
			}
		}
		rendition.on("keyup", keybinding)
		document.addEventListener("keyup", keybinding, false)
		book.ready.then(() => {
			// Load in stored locations from json or local storage
			const key = book.key() + '-locations'
			const stored = localStorage.getItem(key)
			if (stored) {
				return book.locations.load(stored)
			} else {
				// Or generate the locations on the fly
				// Can pass an option number of chars to break sections by
				// default is 150 chars
				// test: [break:549,items:100] (sections:2-12)
				//  2:[0]
				//  3:[1-4-8-12]
				//  4:[14-18-21-24]
				//  5:[25-28-31-34-35]
				//  6:[36-41-44-48]
				//  7:[50-53-56-60]
				//  8:[61-65-69]
				//  9:[71-74-76]
				// 10:[77-81-84-88]
				// 11:[89-92]
				// 12:[95-98-100]
				return book.locations.generate(549)
			}
		}).then((locations) => {

			controls.style.display = "block"
			currentPage.onchange = (e) => {

				rendition.display(locationFrom(e.target.value).cfi)
			}
			slider.onchange = (e) => {

				rendition.display(locationFrom(e.target.value).cfi)
			}
			// Wait for book to be rendered to get current page
			displayed.then(() => {

				update(rendition.currentLocation())
			})
			// Listen for location changed event, get percentage from CFI
			rendition.on("relocated", (location) => {

				update(location)
				console.log(location)
			})
			// Save out the generated locations to JSON
			localStorage.setItem(book.key() + '-locations', book.locations.save())
			console.log("locations.length: " + locations.length)
		})
		book.locations.on("changed", (loc) => {

			console.log(loc)
		})
	</script>
</body>

</html>